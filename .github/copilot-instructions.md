# Mongoidable AI Working Notes
- Purpose: Mongoid-backed, CanCanCan-inspired authorization with static class abilities, embedded instance abilities, and optional policy bundles. Core modules live under [lib/mongoidable](lib/mongoidable).
- Include `Mongoidable::Document` into Mongoid models to get abilities, caching, and callbacks; it pulls in class/instance/current ability logic and renews abilities on init/save/find ([lib/mongoidable/document.rb](lib/mongoidable/document.rb), [lib/mongoidable/document_extensions.rb](lib/mongoidable/document_extensions.rb)).
- Static ability definitions belong in class-level `define_abilities` blocks; inherit from relations via `inherits_abilities_from`/`inherits_abilities_from_many`; attach policy relations with `accepts_policies` ([lib/mongoidable/class_abilities.rb](lib/mongoidable/class_abilities.rb)).
- Ability precedence (highest wins): inherited static/instance from related objects → own static definitions → own instance abilities; use `renew_abilities(types: ...)` to mark caches dirty ([lib/mongoidable/current_ability.rb](lib/mongoidable/current_ability.rb)).
- `Mongoidable::Abilities` extends `CanCan::Ability`, tagging rules with `rule_source` and `rule_type`; `to_casl_list` renders front-end friendly CASL hashes with optional Ruby/JS block serialization ([app/models/mongoidable/abilities.rb](app/models/mongoidable/abilities.rb), [lib/mongoidable/casl_hash.rb](lib/mongoidable/casl_hash.rb), [lib/mongoidable/casl_list.rb](lib/mongoidable/casl_list.rb), [lib/mongoidable/rule.rb](lib/mongoidable/rule.rb)).
- Abilities are embedded docs; `Mongoidable::AbilityUpdater` toggles abilities based on current authorization (destroys existing if redundant, builds if needed) and normalizes extra attributes/conditions ([lib/mongoidable/ability_updater.rb](lib/mongoidable/ability_updater.rb), [app/models/mongoidable/ability.rb](app/models/mongoidable/ability.rb)).
- Policies group abilities; apply/remove via `PoliciesUpdater`, merge requirement placeholders (`merge|path`) into ability extras at runtime, and expose through `PolicyRelation` embeds ([app/models/mongoidable/policy.rb](app/models/mongoidable/policy.rb), [app/models/mongoidable/policy_relation.rb](app/models/mongoidable/policy_relation.rb), [lib/mongoidable/services/policies_updater.rb](lib/mongoidable/services/policies_updater.rb)).
- Config defaults: ability class `Mongoidable::Ability`, load path `app/models/abilities/**/*.rb`, policy collection `mongoidable_policies`, serializers for Ruby/JS blocks enabled, context module optional; override via `Mongoidable.configure` ([lib/mongoidable/configuration.rb](lib/mongoidable/configuration.rb), [lib/mongoidable.rb](lib/mongoidable.rb)).
- Controllers: JSON APIs for abilities/policies using CanCan authorization and query objects; Ability requests require `owner_type` + `owner_id`, optionally `policy_id/policy_relation` or `instance_abilities` payloads; PoliciesController delegates creation/update to `PolicyQuery` ([app/controllers/mongoidable/abilities_controller.rb](app/controllers/mongoidable/abilities_controller.rb), [app/controllers/mongoidable/policies_controller.rb](app/controllers/mongoidable/policies_controller.rb), [app/queries/mongoidable/ability_query.rb](app/queries/mongoidable/ability_query.rb), [app/queries/mongoidable/policy_query.rb](app/queries/mongoidable/policy_query.rb)).
- Serialization: default `AbilitySerializer` normalizes subjects via `ClassType.mongoize`; `PolicySerializer` adds `abilities` (CASL format) and instance ability ids; use concerns to extend ability data if custom fields exist ([app/serializers/mongoidable/ability_serializer.rb](app/serializers/mongoidable/ability_serializer.rb), [app/serializers/mongoidable/policy_serializer.rb](app/serializers/mongoidable/policy_serializer.rb), [app/serializers/mongoidable/concerns](app/serializers/mongoidable/concerns)).
- ActiveRecord is intentionally disabled for CanCan adapters to enforce Mongoid-only behavior ([lib/mongoidable/cancan/active_record_disabler.rb](lib/mongoidable/cancan/active_record_disabler.rb)).
- Spec patterns: RSpec with dummy Rails app; default `rake` task runs specs. Use metadata hooks (`:with_abilities`, `:default_can_ability_with`, `:authorizes_controller`, etc.) to stub authorization behaviors (see [README.md](README.md) and [spec/support](spec/support)).
- Test helpers: `Mongoidable::Rspec` adds controller matchers for `authorize` expectations; many behaviors memoized via `Memoist`, so prefer exercising renew/callback flows rather than stubbing internals.
- Development tips: abilities/policies often memoized—if mutating internals in code or tests, call `renew_abilities` or rebuild the model to flush caches. Ability classes are auto-discovered from `config.load_path`; keep custom subclasses under that path.
- Build/run: `bundle exec rspec` or `bundle exec rake` (loads `spec/dummy` Rails env). MongoDB must be available per `spec/dummy/config/mongoid.yml` when running integration specs.

Let me know if any sections need more depth or if other workflows should be captured.
